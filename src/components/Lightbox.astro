---
// Lightbox component for fullscreen image viewing
---

<div id="lightbox" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden items-center justify-center">
  <button
    id="lightbox-close"
    class="absolute top-4 right-4 text-white text-4xl hover:opacity-70 transition-opacity z-10"
    aria-label="Close lightbox"
  >
    ×
  </button>
  <button
    id="lightbox-prev"
    class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-4xl hover:opacity-70 transition-opacity z-10"
    aria-label="Previous image"
  >
    ‹
  </button>
  <button
    id="lightbox-next"
    class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-4xl hover:opacity-70 transition-opacity z-10"
    aria-label="Next image"
  >
    ›
  </button>
  <img
    id="lightbox-image"
    class="max-h-[95vh] max-w-[95vw] object-contain"
    alt=""
  />
</div>

<script>
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const closeButton = document.getElementById('lightbox-close');
  const prevButton = document.getElementById('lightbox-prev');
  const nextButton = document.getElementById('lightbox-next');

  let currentImages: HTMLImageElement[] = [];
  let currentIndex = 0;

  function getImageId(img: HTMLImageElement): string {
    // Create a unique ID from the image src path
    const fullSrc = img.getAttribute('data-full-src') || img.src;
    // Remove query parameters if present
    const srcWithoutQuery = fullSrc.split('?')[0];
    const match = srcWithoutQuery.match(/\/([^\/]+)\.(?:jpg|jpeg|JPG|JPEG)$/i);
    const id = match ? match[1] : '';
    return id;
  }

  function openLightbox(img: HTMLImageElement, images: HTMLImageElement[]) {
    currentImages = images;
    currentIndex = images.indexOf(img);
    showImage(currentIndex);
    lightbox?.classList.remove('hidden');
    lightbox?.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox?.classList.add('hidden');
    lightbox?.classList.remove('flex');
    document.body.style.overflow = '';
    // Remove the hash from URL
    history.pushState(null, '', window.location.pathname);
  }

  function showImage(index: number) {
    if (index < 0) index = currentImages.length - 1;
    if (index >= currentImages.length) index = 0;
    currentIndex = index;

    const img = currentImages[currentIndex];
    if (lightboxImage && img) {
      // Use data-full-src if available, otherwise fall back to src
      const fullSrc = img.getAttribute('data-full-src') || img.src;
      lightboxImage.src = fullSrc;
      lightboxImage.alt = img.alt;

      // Update URL with image ID
      const imageId = getImageId(img);
      if (imageId) {
        history.pushState(null, '', `#${imageId}`);
      }
    }
  }

  function nextImage() {
    showImage(currentIndex + 1);
  }

  function prevImage() {
    showImage(currentIndex - 1);
  }

  // Event listeners
  closeButton?.addEventListener('click', closeLightbox);
  prevButton?.addEventListener('click', prevImage);
  nextButton?.addEventListener('click', nextImage);

  // Close on background click
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('hidden')) {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') prevImage();
      if (e.key === 'ArrowRight') nextImage();
    }
  });

  // Initialize: make all portfolio images clickable
  function initializeLightbox() {
    const portfolioImages = Array.from(document.querySelectorAll('.lightbox-image')) as HTMLImageElement[];

    portfolioImages.forEach((img) => {
      img.style.cursor = 'pointer';
      img.addEventListener('click', () => {
        openLightbox(img, portfolioImages);
      });
    });
  }

  // Check if URL has a hash on page load and open that image
  function checkHashOnLoad() {
    const hash = window.location.hash.slice(1); // Remove the #
    if (hash) {
      const portfolioImages = Array.from(document.querySelectorAll('.lightbox-image')) as HTMLImageElement[];
      const targetImage = portfolioImages.find(img => getImageId(img) === hash);
      if (targetImage) {
        openLightbox(targetImage, portfolioImages);
      }
    }
  }

  // Run on page load
  initializeLightbox();
  checkHashOnLoad();

  // Re-run after view transitions (if using Astro view transitions)
  document.addEventListener('astro:page-load', () => {
    initializeLightbox();
    checkHashOnLoad();
  });
</script>
