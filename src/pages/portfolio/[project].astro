---
import { getCollection, getEntry, render } from 'astro:content';
import type { ImageMetadata } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PhotoGallery from '../../components/PhotoGallery.astro';
import { extractExif } from '../../utils/exif';
import { exifConfig } from '../../config/exif';
import { humanizeProjectName, getNewestPhotoDate } from '../../utils/projects';

export async function getStaticPaths() {
  // Discover all projects from www/ directory
  const wwwImages = import.meta.glob<{ default: ImageMetadata }>('/src/content/www/**/*.{jpg,jpeg,JPG,JPEG}', { eager: true });

  // Get unique project slugs
  const projectSlugs = new Set<string>();
  for (const path of Object.keys(wwwImages)) {
    const match = path.match(/\/src\/content\/www\/(.+?)\//);
    if (match) {
      projectSlugs.add(match[1]);
    }
  }

  return Array.from(projectSlugs).map(slug => ({
    params: { project: slug }
  }));
}

const { project: projectSlug } = Astro.params;

// Load metadata if it exists
const metadata = await getEntry('photoProjects', projectSlug);

// Get title, description, date (from metadata or auto-generate)
const title = metadata?.data.title || humanizeProjectName(projectSlug);
const description = metadata?.data.description || '';
const exifDisplay = metadata?.data.exifDisplay || 'inherit';
const exifFields = metadata?.data.exifFields;

// Render markdown content if metadata exists
let Content = null;
if (metadata) {
  const rendered = await render(metadata);
  Content = rendered.Content;
}

// Discover all images in this project's www/ directory
const imagePattern = `/src/content/www/${projectSlug}/**/*.{jpg,jpeg,JPG,JPEG}`;
const allWwwImages = import.meta.glob<{ default: ImageMetadata }>('/src/content/www/**/*.{jpg,jpeg,JPG,JPEG}', { eager: true });

// Filter images for this project only
const projectImages = Object.entries(allWwwImages)
  .filter(([path]) => path.startsWith(`/src/content/www/${projectSlug}/`))
  .map(([path, module]) => ({
    path,
    image: module.default,
    filename: path.split('/').pop() || ''
  }))
  .sort((a, b) => a.filename.localeCompare(b.filename));

// Get date for the project
const date = metadata?.data.date || await getNewestPhotoDate(projectImages);
const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Extract EXIF data for each image
const photos = await Promise.all(
  projectImages.map(async ({ image, path }) => {
    // Convert virtual path to filesystem path
    const fsPath = path.replace(/^\/src\//, './src/');
    const exif = await extractExif(fsPath);
    return { image, exif };
  })
);

// Determine if EXIF should be shown
const showExif = exifDisplay === 'on' || (exifDisplay === 'inherit' && exifConfig.defaultDisplay);
const fieldsToShow = exifFields || exifConfig.defaultFields;
---

<BaseLayout title={`${title} - Dan Cardamore`} description={description || `Photography project: ${title}`}>
  <div class="max-w-6xl mx-auto space-y-12">
    <div class="space-y-4">
      <a href="/portfolio" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">
        ‚Üê Back to Portfolio
      </a>
      <div class="space-y-2">
        <h1 class="text-4xl font-light">{title}</h1>
        <p class="text-sm text-gray-500">{formattedDate}</p>
      </div>
      {Content && (
        <div class="prose prose-gray max-w-none">
          <Content />
        </div>
      )}
      {!Content && description && (
        <p class="text-gray-700">{description}</p>
      )}
    </div>

    <PhotoGallery
      photos={photos}
      showExif={showExif}
      exifFields={fieldsToShow}
    />
  </div>
</BaseLayout>
